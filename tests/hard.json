[
    {
        "dialect": "mysql",
        "query": "with cte as (select id,\r\n                    amount,\r\n                    case when amount > 1000 then 0 else amount end sm,\r\n                    case when amount > 1000 then 0 else 1 end      keep\r\n             from mytable\r\n             where id = 1\r\n             union all\r\n             select t.id,\r\n                    t.amount,\r\n                    case when c.sm + t.amount > 1000 then c.sm else c.sm + t.amount end,\r\n                    case when c.sm + t.amount > 1000 then 0 else 1 end\r\n             from cte c\r\n                      inner join mytable t on t.id = c.id + 1)\r\nselect id, amount\r\nfrom cte\r\nwhere keep = 1\r\norder by id",
        "stats": {
            "subqueries": 0,
            "columns": [
                "id",
                "amount",
                "keep",
                "id"
            ],
            "numbers": [
                1
            ],
            "strings": [],
            "string_types": [],
            "tables": [],
            "databases": [],
            "expressions_per_clause": {
                "select": 2,
                "from": 1,
                "where": 3,
                "group_by": 0,
                "having": 0,
                "order_by": 1,
                "limit": 0,
                "offset": 0
            },
            "expressions_per_type": {
                "unary_expr": 0,
                "binary_expr": 1,
                "number": 1,
                "column_ref": 4,
                "aggr_func": 0,
                "expr_list": 0,
                "star": 0,
                "function": 0,
                "string": 0
            },
            "select": null,
            "meta": {
                "case_usage": [
                    "snake_case"
                ],
                "quote_usage": [],
                "table_usage": [],
                "database_usage": []
            }
        },
        "ast": {
            "tableList": [
                "select::null::mytable",
                "select::null::cte"
            ],
            "columnList": [
                "select::null::id",
                "select::null::amount",
                "select::mytable::id",
                "select::mytable::amount",
                "select::cte::sm",
                "select::cte::id",
                "select::null::keep"
            ],
            "ast": {
                "with": [
                    {
                        "name": {
                            "type": "default",
                            "value": "cte"
                        },
                        "stmt": {
                            "tableList": [
                                "select::null::mytable",
                                "select::null::cte"
                            ],
                            "columnList": [
                                "select::null::id",
                                "select::null::amount",
                                "select::mytable::id",
                                "select::mytable::amount",
                                "select::cte::sm",
                                "select::cte::id",
                                "select::null::keep"
                            ],
                            "ast": {
                                "with": null,
                                "type": "select",
                                "options": null,
                                "distinct": null,
                                "columns": [
                                    {
                                        "expr": {
                                            "type": "column_ref",
                                            "table": null,
                                            "column": "id"
                                        },
                                        "as": null
                                    },
                                    {
                                        "expr": {
                                            "type": "column_ref",
                                            "table": null,
                                            "column": "amount"
                                        },
                                        "as": null
                                    },
                                    {
                                        "expr": {
                                            "type": "case",
                                            "expr": null,
                                            "args": [
                                                {
                                                    "type": "when",
                                                    "cond": {
                                                        "type": "binary_expr",
                                                        "operator": ">",
                                                        "left": {
                                                            "type": "column_ref",
                                                            "table": null,
                                                            "column": "amount"
                                                        },
                                                        "right": {
                                                            "type": "number",
                                                            "value": 1000
                                                        }
                                                    },
                                                    "result": {
                                                        "type": "number",
                                                        "value": 0
                                                    }
                                                },
                                                {
                                                    "type": "else",
                                                    "result": {
                                                        "type": "column_ref",
                                                        "table": null,
                                                        "column": "amount"
                                                    }
                                                }
                                            ]
                                        },
                                        "as": "sm"
                                    },
                                    {
                                        "expr": {
                                            "type": "case",
                                            "expr": null,
                                            "args": [
                                                {
                                                    "type": "when",
                                                    "cond": {
                                                        "type": "binary_expr",
                                                        "operator": ">",
                                                        "left": {
                                                            "type": "column_ref",
                                                            "table": null,
                                                            "column": "amount"
                                                        },
                                                        "right": {
                                                            "type": "number",
                                                            "value": 1000
                                                        }
                                                    },
                                                    "result": {
                                                        "type": "number",
                                                        "value": 0
                                                    }
                                                },
                                                {
                                                    "type": "else",
                                                    "result": {
                                                        "type": "number",
                                                        "value": 1
                                                    }
                                                }
                                            ]
                                        },
                                        "as": "keep"
                                    }
                                ],
                                "into": {
                                    "position": null
                                },
                                "from": [
                                    {
                                        "db": null,
                                        "table": "mytable",
                                        "as": null
                                    }
                                ],
                                "where": {
                                    "type": "binary_expr",
                                    "operator": "=",
                                    "left": {
                                        "type": "column_ref",
                                        "table": null,
                                        "column": "id"
                                    },
                                    "right": {
                                        "type": "number",
                                        "value": 1
                                    }
                                },
                                "groupby": null,
                                "having": null,
                                "orderby": null,
                                "limit": null,
                                "locking_read": null,
                                "window": null,
                                "_next": {
                                    "with": null,
                                    "type": "select",
                                    "options": null,
                                    "distinct": null,
                                    "columns": [
                                        {
                                            "expr": {
                                                "type": "column_ref",
                                                "table": "t",
                                                "column": "id"
                                            },
                                            "as": null
                                        },
                                        {
                                            "expr": {
                                                "type": "column_ref",
                                                "table": "t",
                                                "column": "amount"
                                            },
                                            "as": null
                                        },
                                        {
                                            "expr": {
                                                "type": "case",
                                                "expr": null,
                                                "args": [
                                                    {
                                                        "type": "when",
                                                        "cond": {
                                                            "type": "binary_expr",
                                                            "operator": ">",
                                                            "left": {
                                                                "type": "binary_expr",
                                                                "operator": "+",
                                                                "left": {
                                                                    "type": "column_ref",
                                                                    "table": "c",
                                                                    "column": "sm"
                                                                },
                                                                "right": {
                                                                    "type": "column_ref",
                                                                    "table": "t",
                                                                    "column": "amount"
                                                                }
                                                            },
                                                            "right": {
                                                                "type": "number",
                                                                "value": 1000
                                                            }
                                                        },
                                                        "result": {
                                                            "type": "column_ref",
                                                            "table": "c",
                                                            "column": "sm"
                                                        }
                                                    },
                                                    {
                                                        "type": "else",
                                                        "result": {
                                                            "type": "binary_expr",
                                                            "operator": "+",
                                                            "left": {
                                                                "type": "column_ref",
                                                                "table": "c",
                                                                "column": "sm"
                                                            },
                                                            "right": {
                                                                "type": "column_ref",
                                                                "table": "t",
                                                                "column": "amount"
                                                            }
                                                        }
                                                    }
                                                ]
                                            },
                                            "as": null
                                        },
                                        {
                                            "expr": {
                                                "type": "case",
                                                "expr": null,
                                                "args": [
                                                    {
                                                        "type": "when",
                                                        "cond": {
                                                            "type": "binary_expr",
                                                            "operator": ">",
                                                            "left": {
                                                                "type": "binary_expr",
                                                                "operator": "+",
                                                                "left": {
                                                                    "type": "column_ref",
                                                                    "table": "c",
                                                                    "column": "sm"
                                                                },
                                                                "right": {
                                                                    "type": "column_ref",
                                                                    "table": "t",
                                                                    "column": "amount"
                                                                }
                                                            },
                                                            "right": {
                                                                "type": "number",
                                                                "value": 1000
                                                            }
                                                        },
                                                        "result": {
                                                            "type": "number",
                                                            "value": 0
                                                        }
                                                    },
                                                    {
                                                        "type": "else",
                                                        "result": {
                                                            "type": "number",
                                                            "value": 1
                                                        }
                                                    }
                                                ]
                                            },
                                            "as": null
                                        }
                                    ],
                                    "into": {
                                        "position": null
                                    },
                                    "from": [
                                        {
                                            "db": null,
                                            "table": "cte",
                                            "as": "c"
                                        },
                                        {
                                            "db": null,
                                            "table": "mytable",
                                            "as": "t",
                                            "join": "INNER JOIN",
                                            "on": {
                                                "type": "binary_expr",
                                                "operator": "=",
                                                "left": {
                                                    "type": "column_ref",
                                                    "table": "t",
                                                    "column": "id"
                                                },
                                                "right": {
                                                    "type": "binary_expr",
                                                    "operator": "+",
                                                    "left": {
                                                        "type": "column_ref",
                                                        "table": "c",
                                                        "column": "id"
                                                    },
                                                    "right": {
                                                        "type": "number",
                                                        "value": 1
                                                    }
                                                }
                                            }
                                        }
                                    ],
                                    "where": null,
                                    "groupby": null,
                                    "having": null,
                                    "orderby": null,
                                    "limit": null,
                                    "locking_read": null,
                                    "window": null
                                },
                                "set_op": "union all"
                            }
                        },
                        "columns": null
                    }
                ],
                "type": "select",
                "options": null,
                "distinct": null,
                "columns": [
                    {
                        "expr": {
                            "type": "column_ref",
                            "table": null,
                            "column": "id"
                        },
                        "as": null
                    },
                    {
                        "expr": {
                            "type": "column_ref",
                            "table": null,
                            "column": "amount"
                        },
                        "as": null
                    }
                ],
                "into": {
                    "position": null
                },
                "from": [
                    {
                        "db": null,
                        "table": "cte",
                        "as": null
                    }
                ],
                "where": {
                    "type": "binary_expr",
                    "operator": "=",
                    "left": {
                        "type": "column_ref",
                        "table": null,
                        "column": "keep"
                    },
                    "right": {
                        "type": "number",
                        "value": 1
                    }
                },
                "groupby": null,
                "having": null,
                "orderby": [
                    {
                        "expr": {
                            "type": "column_ref",
                            "table": null,
                            "column": "id"
                        },
                        "type": "ASC"
                    }
                ],
                "limit": null,
                "locking_read": null,
                "window": null
            }
        },
        "complexity": 3.125
    }
]